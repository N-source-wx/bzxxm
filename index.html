<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>海棠礦工活動 - 慕慕計算器 (C2.1)</title>
    <style>
        :root {
            --primary: #4a6fa5;
            --secondary: #6e9887;
            --accent: #e76f51;
            --light: #f8f9fa;
            --dark: #2d3e50;
            --success: #2a9d8f;
            --warning: #e9c46a;
            --danger: #e76f51;
            --gradient: linear-gradient(135deg, var(--primary), var(--secondary));
            --shadow-light: 0 3px 10px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 5px 20px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --transition: all 0.3s ease;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-medium);
            overflow: hidden;
            animation: fadeIn 0.6s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        header {
            background: var(--gradient);
            color: white;
            padding: 25px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }
        
        .description {
            font-size: 14px;
            opacity: 0.9;
            font-style: italic;
            position: relative;
            z-index: 1;
        }
        
        .calculator-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        
        .panel {
            background: var(--light);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow-light);
            transition: var(--transition);
            border: 1px solid transparent;
        }
        
        .panel:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
            border-color: var(--primary);
        }
        
        .panel-title {
            font-size: 18px;
            color: var(--primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--secondary);
            position: relative;
        }
        
        .panel-title::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--accent);
            transition: width 0.3s ease;
        }
        
        .panel:hover .panel-title::after {
            width: 50px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }
        
        .input-row label {
            margin-bottom: 0;
            flex: 1;
            font-weight: 500;
        }
        
        .input-row input {
            width: 100px;
            text-align: right;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark);
        }
        
        input[type="number"], input[type="text"], select {
            padding: 10px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            transition: var(--transition);
            background: white;
        }
        
        input[type="number"]:focus, input[type="text"]:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.1);
        }
        
        input[type="number"]:invalid {
            border-color: var(--danger);
        }
        
        button {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transition: width 0.3s, height 0.3s;
            transform: translate(-50%, -50%);
        }
        
        button:hover::before {
            width: 100%;
            height: 100%;
        }
        
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 111, 165, 0.3);
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: var(--gradient);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        tr:hover {
            background-color: #e3f2fd;
            transition: background-color 0.2s ease;
        }
        
        tr.achieved-level {
            background: linear-gradient(90deg, var(--warning), #f4e6a1);
            font-weight: bold;
        }
        
        .result-box {
            background: linear-gradient(135deg, #e9f7ef, #d4edda);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 15px;
            border-left: 4px solid var(--success);
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 5px 0;
        }
        
        .result-item:last-child {
            margin-bottom: 0;
        }
        
        .result-value {
            font-weight: 700;
            color: var(--success);
            font-size: 16px;
        }
        
        .day-columns {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .day-column {
            background: white;
            padding: 15px;
            border-radius: var(--border-radius);
            border: 2px solid #e9ecef;
            transition: var(--transition);
        }
        
        .day-column:hover {
            border-color: var(--primary);
            transform: translateY(-1px);
        }
        
        .day-input {
            width: 100% !important;
        }
        
        .day-title {
            text-align: center;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary);
            font-size: 14px;
        }
        
        .package-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px 15px;
            background: white;
            border-radius: var(--border-radius);
            border: 2px solid #e9ecef;
            transition: var(--transition);
        }
        
        .package-item:hover {
            border-color: var(--primary);
        }
        
        .package-item input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
        }
        
        .package-info {
            display: flex;
            align-items: center;
            flex: 1;
            margin-right: 10px;
        }
        
        .package-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .package-controls input {
            width: 60px;
            text-align: center;
            padding: 5px 8px;
            font-size: 13px;
        }
        
        .exp-input {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .exp-input input {
            width: 70px;
            text-align: center;
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .error-message {
            color: var(--danger);
            font-size: 12px;
            margin-top: 5px;
        }
        
        .success-message {
            color: var(--success);
            font-size: 12px;
            margin-top: 5px;
        }
        
        .tooltip {
            position: relative;
            cursor: help;
        }
        
        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        
        .tooltip:hover::after {
            opacity: 1;
        }
        
        .input-valid {
            border-color: var(--success) !important;
        }
        
        .input-warning {
            border-color: var(--warning) !important;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--gradient);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        @media (max-width: 768px) {
            .calculator-container {
                grid-template-columns: 1fr;
                padding: 15px;
            }
            
            .input-row {
                flex-direction: column;
                align-items: stretch;
                gap: 5px;
            }
            
            .input-row input {
                width: 100%;
                text-align: left;
            }
            
            .day-columns {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 10px;
            }
            
            .package-item {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>海棠礦工活動 - 慕慕計算器 (v2.0)</h1>
            <p class="description">本計算結果僅供參考</p>
        </header>
        
        <div class="calculator-container">
            <!-- 第一欄：當前狀態和總經驗計算 -->
            <div class="panel">
                <h2 class="panel-title">當前狀態與總經驗計算</h2>
                
                <div class="input-row">
                    <label for="current-hooks" class="tooltip" data-tooltip="請輸入目前擁有的鉤子數量">目前鉤子數量</label>
                    <input type="number" id="current-hooks" value="0" min="0" max="9999">
                </div>
                
                <div class="input-row">
                    <label for="current-bombs" class="tooltip" data-tooltip="請輸入目前擁有的炸彈數量">目前炸彈數量</label>
                    <input type="number" id="current-bombs" value="0" min="0" max="9999">
                </div>
                
                <div class="input-row">
                    <label for="current-exp" class="tooltip" data-tooltip="請輸入目前的經驗分數">目前經驗分數</label>
                    <input type="number" id="current-exp" value="0" min="0" max="99999">
                </div>
                
                <div class="result-box">
                    <h3>經驗預估</h3>
                    
                    <div class="input-row">
                        <label for="hook-exp-value" class="tooltip" data-tooltip="每個鉤子可獲得的經驗值(10-18)">1鉤子經驗</label>
                        <input type="number" id="hook-exp-value" value="15" min="10" max="18">
                    </div>
                    
                    <div class="result-item">
                        <span>預估獲得鉤子數量｜經驗:</span>
                        <span id="hook-result" class="result-value">0｜0</span>
                    </div>
                    
                    <div class="result-item">
                        <span>預估獲得炸彈數量｜經驗:</span>
                        <span id="bomb-result" class="result-value">0｜0</span>
                    </div>
                    
                    <div class="result-item">
                        <span>預估消費葉子:</span>
                        <span id="total-leaves" class="result-value">0</span>
                    </div>
                    
                    <div class="result-item">
                        <span>預估累計總經驗:</span>
                        <span id="total-exp" class="result-value">0</span>
                    </div>
                    
                    <div class="result-item">
                        <span>當前等級進度:</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="level-progress"></div>
                    </div>
                    
                    <div class="result-item">
                        <span>預估達到等級與獎勵:</span>
                        <span id="estimated-level" class="result-value">LV1 - 門派玉牌*5</span>
                    </div>
                </div>
            </div>
            
            <!-- 第二欄：每日免費領取 -->
            <div class="panel">
                <h2 class="panel-title">每日免費領取</h2>
                
                <div class="day-columns">
                    <!-- 7天的免費領取輸入區域將通過JavaScript動態生成 -->
                </div>
                
                <div class="result-box">
                    <h3>免費領取總計</h3>
                    <div class="result-item">
                        <span>總鉤子數量:</span>
                        <span id="free-hooks" class="result-value">140</span>
                    </div>
                    <div class="result-item">
                        <span>總炸彈數量:</span>
                        <span id="free-bombs" class="result-value">14</span>
                    </div>
                    <div class="result-item">
                        <span>總經驗值:</span>
                        <span id="free-exp" class="result-value">2240</span>
                    </div>
                </div>
            </div>
            
            <!-- 第三欄：每日消費計算 -->
            <div class="panel">
                <h2 class="panel-title">每日消費計算 (7天)</h2>
                
                <div class="day-columns">
                    <!-- 7天的消費輸入區域將通過JavaScript動態生成 -->
                </div>
                
                <div class="result-box">
                    <h3>每日消費總計</h3>
                    <div class="result-item">
                        <span>總鉤子數量:</span>
                        <span id="daily-hooks" class="result-value">0</span>
                    </div>
                    <div class="result-item">
                        <span>總炸彈數量:</span>
                        <span id="daily-bombs" class="result-value">0</span>
                    </div>
                    <div class="result-item">
                        <span>總消費葉子:</span>
                        <span id="daily-leaves" class="result-value">0</span>
                    </div>
                </div>
            </div>
            
            <!-- 第四欄：累計儲值計算 -->
            <div class="panel">
                <h2 class="panel-title">累計儲值計算</h2>
                <div class="input-group">
                    <label for="total-topup">累計儲值葉子數量</label>
                    <select id="total-topup">
                        <option value="0">0</option>
                        <option value="300">300</option>
                        <option value="600">600</option>
                        <option value="1000">1000</option>
                        <option value="2000">2000</option>
                        <option value="4000">4000</option>
                        <option value="9000">9000</option>
                        <option value="14000">14000</option>
                        <option value="20000">20000</option>
                        <option value="28000">28000</option>
                        <option value="40000">40000</option>
                        <option value="60000">60000</option>
                        <option value="70000">70000</option>
                    </select>
                </div>
                
                <div class="result-box">
                    <h3>儲值獎勵</h3>
                    <div class="result-item">
                        <span>可獲得鉤子:</span>
                        <span id="topup-hooks" class="result-value">0</span>
                    </div>
                </div>
            </div>
            
            <!-- 第五欄：超值禮包選擇 -->
            <div class="panel">
                <h2 class="panel-title">超值禮包選擇</h2>
                
                <div id="package-list">
                    <!-- 禮包選項將通過JavaScript動態生成 -->
                </div>
                
                <div class="result-box">
                    <h3>禮包總計</h3>
                    <div class="result-item">
                        <span>可獲得鉤子:</span>
                        <span id="package-hooks" class="result-value">0</span>
                    </div>
                    <div class="result-item">
                        <span>總花費:</span>
                        <span id="package-cost" class="result-value">0 NTD</span>
                    </div>
                </div>
            </div>
            
            <!-- 第六欄：等級獎勵對照表 -->
            <div class="panel">
                <h2 class="panel-title">等級獎勵對照表</h2>
                <div class="table-container">
                    <table id="reward-table">
                        <thead>
                            <tr>
                                <th>等級</th>
                                <th>升級經驗</th>
                                <th>總經驗</th>
                                <th>獎勵</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 等級數據將通過JavaScript動態生成 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 等級數據 - 修正版本
        const levelData = [
            { level: 1, expRequired: 50, totalExp: 50, reward: "門派玉牌*5" },
            { level: 2, expRequired: 50, totalExp: 100, reward: "英雄酒*5" },
            { level: 3, expRequired: 100, totalExp: 200, reward: "天之隕星*3" },
            { level: 4, expRequired: 100, totalExp: 300, reward: "紫雲金*4" },
            { level: 5, expRequired: 200, totalExp: 500, reward: "萌萌果*30" },
            { level: 6, expRequired: 200, totalExp: 700, reward: "3級自選寶石*1" },
            { level: 7, expRequired: 200, totalExp: 900, reward: "自選紅色卡牌*1" },
            { level: 8, expRequired: 250, totalExp: 1150, reward: "幻夢袍*2 (弟子金服裝)" },
            { level: 9, expRequired: 250, totalExp: 1400, reward: "坐騎琥珀寶箱*2" },
            { level: 10, expRequired: 250, totalExp: 1650, reward: "翅膀羽毛寶箱*2" },
            { level: 11, expRequired: 350, totalExp: 2000, reward: "橙色化身自選寶箱*1" },
            { level: 12, expRequired: 350, totalExp: 2350, reward: "通世法寶碎片(天地劍)*10" },
            { level: 13, expRequired: 350, totalExp: 2700, reward: "曹正淳碎片*20" },
            { level: 14, expRequired: 450, totalExp: 3150, reward: "黃神機圖紙*1" },
            { level: 15, expRequired: 450, totalExp: 3600, reward: "紅神機碎片*10" },
            { level: 16, expRequired: 450, totalExp: 4050, reward: "神珍鐵*100" },
            { level: 17, expRequired: 600, totalExp: 4650, reward: "神機木*100" },
            { level: 18, expRequired: 600, totalExp: 5250, reward: "神機齒輪*1" },
            { level: 19, expRequired: 600, totalExp: 5850, reward: "4級自選寶石*1" },
            { level: 20, expRequired: 800, totalExp: 6650, reward: "彩色自選神兵碎片*20" },
            { level: 21, expRequired: 800, totalExp: 7450, reward: "紅神機圖紙*1" },
            { level: 22, expRequired: 800, totalExp: 8250, reward: "兵器核心*100" },
            { level: 23, expRequired: 1000, totalExp: 9250, reward: "仙刻刀*30" },
            { level: 24, expRequired: 1000, totalExp: 10250, reward: "通用彩色法寶升星碎片*20" },
            { level: 25, expRequired: 1000, totalExp: 11250, reward: "仙靈之石*200" },
            { level: 26, expRequired: 1200, totalExp: 12450, reward: "紅玉*1" },
            { level: 27, expRequired: 1200, totalExp: 13650, reward: "造化仙經*15" },
            { level: 28, expRequired: 1200, totalExp: 14850, reward: "星君神酒*5" },
            { level: 29, expRequired: 1350, totalExp: 16200, reward: "隨機黃色靈珠袋*1" },
            { level: 30, expRequired: 1350, totalExp: 17550, reward: "彩品自選門客碎片*10" },
            { level: 31, expRequired: 1350, totalExp: 18900, reward: "絕世匠神之錘*30" },
            { level: 32, expRequired: 1350, totalExp: 20250, reward: "彩弟子雲羅郡主" },
            { level: 33, expRequired: 1350, totalExp: 21600, reward: "彩色弟子袍*1" },
            { level: 34, expRequired: 1350, totalExp: 22950, reward: "彩品隨機弟子功法*1" },
            { level: 35, expRequired: 1350, totalExp: 24300, reward: "天罡陣*1" },
            { level: 36, expRequired: 1350, totalExp: 25650, reward: "高級仙火*10" },
            { level: 37, expRequired: 1350, totalExp: 27000, reward: "7級自選寶石*1" },
            { level: 38, expRequired: 1350, totalExp: 28350, reward: "極品定緣珠*1" },
            { level: 39, expRequired: 1350, totalExp: 29700, reward: "自選境界神通*10" },
            { level: 40, expRequired: 1350, totalExp: 0, reward: "平天力王化身" }
        ];

        // 儲值獎勵數據
        const topupRewards = [
            { leaves: 300, hooks: 20 },
            { leaves: 600, hooks: 30 },
            { leaves: 1000, hooks: 50 },
            { leaves: 2000, hooks: 70 },
            { leaves: 4000, hooks: 100 },
            { leaves: 9000, hooks: 200 },
            { leaves: 14000, hooks: 250 },
            { leaves: 20000, hooks: 250 },
            { leaves: 28000, hooks: 300 },
            { leaves: 40000, hooks: 400 },
            { leaves: 60000, hooks: 400 }
        ];

        // 消費獎勵等級
        const consumptionRewards = [
            { leaves: 200, hooks: 3 },
            { leaves: 500, hooks: 3 },
            { leaves: 1000, hooks: 5 },
            { leaves: 2000, hooks: 10 },
            { leaves: 4000, hooks: 20 },
            { leaves: 6000, hooks: 40 },
            { leaves: 9500, hooks: 60 },
            { leaves: 18000, hooks: 90 }
        ];

        // 禮包數據
        const packages = [
            { name: "0.99美金禮包", price: 30, hooks: 10, limit: 1 },
            { name: "4.99美金禮包", price: 150, hooks: 10, limit: 3 },
            { name: "14.99美金禮包", price: 432, hooks: 15, limit: 3 },
            { name: "19.99美金禮包", price: 590, hooks: 20, limit: 4 },
            { name: "99.99美金禮包", price: 2896, hooks: 70, limit: 3 }
        ];

        // 工具函數：防抖
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 工具函數：輸入驗證
        function validateInput(element, min = 0, max = Infinity) {
            const value = parseFloat(element.value) || 0;
            
            if (value < min || value > max) {
                element.classList.add('input-warning');
                return false;
            } else {
                element.classList.remove('input-warning');
                element.classList.add('input-valid');
                setTimeout(() => element.classList.remove('input-valid'), 1000);
                return true;
            }
        }

        // 初始化函數
        function init() {
            // 生成等級表格
            generateLevelTable();
            
            // 生成每日免費領取輸入區域
            generateFreeInputs();
            
            // 生成每日消費輸入區域
            generateDailyInputs();
            
            // 生成禮包選擇區域
            generatePackageOptions();
            
            // 添加事件監聽器（使用防抖優化）
            const debouncedUpdate = debounce(updateAllCalculations, 300);
            
            // 主要輸入欄位
            document.getElementById('current-exp').addEventListener('input', (e) => {
                validateInput(e.target, 0, 99999);
                debouncedUpdate();
            });
            document.getElementById('current-hooks').addEventListener('input', (e) => {
                validateInput(e.target, 0, 9999);
                debouncedUpdate();
            });
            document.getElementById('current-bombs').addEventListener('input', (e) => {
                validateInput(e.target, 0, 9999);
                debouncedUpdate();
            });
            document.getElementById('hook-exp-value').addEventListener('input', (e) => {
                validateInput(e.target, 10, 18);
                debouncedUpdate();
            });
            document.getElementById('total-topup').addEventListener('change', updateAllCalculations);
            
            // 初始計算
            updateAllCalculations();
        }

        // 生成等級表格
        function generateLevelTable() {
            const tableBody = document.querySelector('#reward-table tbody');
            tableBody.innerHTML = '';
            
            levelData.forEach(data => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>LV${data.level}</td>
                    <td>${data.expRequired ? data.expRequired.toLocaleString() : '-'}</td>
                    <td>${data.totalExp.toLocaleString()}</td>
                    <td>${data.reward}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // 生成每日免費領取輸入區域
        function generateFreeInputs() {
            const dayColumns = document.querySelector('.day-columns');
            dayColumns.innerHTML = '';
            
            for (let day = 1; day <= 7; day++) {
                // 設定預設值：第1天和第2天為0，其他天數為20鉤子、2炸彈
                const defaultHooks = (day === 1 || day === 2) ? "0" : "20";
                const defaultBombs = (day === 1 || day === 2) ? "0" : "2";
                
                const column = document.createElement('div');
                column.className = 'day-column';
                column.innerHTML = `
                    <div class="day-title">第${day}天</div>
                    <div class="input-group">
                        <label for="free-day-${day}-hooks">未領取鉤子</label>
                        <select id="free-day-${day}-hooks" data-day="${day}" class="day-input">
                            <option value="0" ${defaultHooks === "0" ? "selected" : ""}>0</option>
                            <option value="20" ${defaultHooks === "20" ? "selected" : ""}>20</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="free-day-${day}-bombs">未領取炸彈</label>
                        <select id="free-day-${day}-bombs" data-day="${day}" class="day-input">
                            <option value="0" ${defaultBombs === "0" ? "selected" : ""}>0</option>
                            <option value="2" ${defaultBombs === "2" ? "selected" : ""}>2</option>
                        </select>
                    </div>
                `;
                dayColumns.appendChild(column);
                
                // 添加事件監聽（使用防抖）
                const debouncedUpdate = debounce(updateAllCalculations, 300);
                document.getElementById(`free-day-${day}-hooks`).addEventListener('change', debouncedUpdate);
                document.getElementById(`free-day-${day}-bombs`).addEventListener('change', debouncedUpdate);
            }
        }

        // 生成每日消費輸入區域
        function generateDailyInputs() {
            const consumeContainer = document.querySelectorAll('.day-columns')[1]; // 第二個day-columns容器
            consumeContainer.innerHTML = '';
            
            for (let day = 1; day <= 7; day++) {
                const column = document.createElement('div');
                column.className = 'day-column';
                column.innerHTML = `
                    <div class="day-title">第${day}天</div>
                    <div class="input-group">
                        <label for="day-${day}-bombs">炸彈數量</label>
                        <input type="number" id="day-${day}-bombs" value="0" min="0" max="100" 
                               data-day="${day}" class="day-input" placeholder="0-100">
                    </div>
                    <div class="input-group">
                        <label for="day-${day}-leaves">消費葉子</label>
                        <input type="number" id="day-${day}-leaves" value="0" min="0" 
                               data-day="${day}" class="day-input" placeholder="額外消費">
                    </div>
                    <div class="result-item">
                        <span>獲得鉤子:</span>
                        <span id="day-${day}-hooks" class="result-value">0</span>
                    </div>
                `;
                consumeContainer.appendChild(column);
                
                // 添加事件監聽（使用防抖）
                const debouncedUpdate = debounce(updateAllCalculations, 300);
                const bombInput = document.getElementById(`day-${day}-bombs`);
                const leavesInput = document.getElementById(`day-${day}-leaves`);
                
                bombInput.addEventListener('input', (e) => {
                    validateInput(e.target, 0, 100);
                    // 自動計算炸彈消費的葉子
                    const bombs = parseInt(e.target.value) || 0;
                    const currentLeaves = parseInt(leavesInput.value) || 0;
                    const bombLeaves = bombs * 10;
                    // 更新葉子數量（如果用戶沒有手動輸入額外消費）
                    if (currentLeaves < bombLeaves) {
                        leavesInput.value = bombLeaves;
                    }
                    debouncedUpdate();
                });
                
                leavesInput.addEventListener('input', (e) => {
                    validateInput(e.target, 0, 99999);
                    debouncedUpdate();
                });
            }
        }

        // 生成禮包選擇區域
        function generatePackageOptions() {
            const packageList = document.getElementById('package-list');
            packageList.innerHTML = '';
            
            packages.forEach((pkg, index) => {
                const item = document.createElement('div');
                item.className = 'package-item';
                item.innerHTML = `
                    <div class="package-info">
                        <input type="checkbox" id="package-${index}" data-index="${index}">
                        <label for="package-${index}">${pkg.name} (${pkg.hooks}鉤子 - ${pkg.price})</label>
                    </div>
                    <div class="package-controls">
                        <span>數量:</span>
                        <input type="number" id="package-${index}-qty" value="0" min="0" max="${pkg.limit}" 
                               data-index="${index}" placeholder="0-${pkg.limit}">
                    </div>
                `;
                packageList.appendChild(item);
                
                // 添加事件監聽
                const checkbox = document.getElementById(`package-${index}`);
                const quantityInput = document.getElementById(`package-${index}-qty`);
                
                checkbox.addEventListener('change', (e) => {
                    const qty = quantityInput.value;
                    if (e.target.checked && (qty === '0' || qty === '')) {
                        quantityInput.value = 1;
                    } else if (!e.target.checked) {
                        quantityInput.value = 0;
                    }
                    updateAllCalculations();
                });
                
                quantityInput.addEventListener('input', (e) => {
                    validateInput(e.target, 0, pkg.limit);
                    const qty = parseInt(e.target.value) || 0;
                    checkbox.checked = qty > 0;
                    updateAllCalculations();
                });
            });
        }

        // 計算消費葉子可獲得的鉤子數量
        function calculateHooksFromLeaves(leaves) {
            let totalHooks = 0;
            for (const reward of consumptionRewards) {
                if (leaves >= reward.leaves) {
                    totalHooks += reward.hooks;
                }
            }
            return totalHooks;
        }

        // 更新每日免費領取計算
        function updateFreeCalculations() {
            let totalFreeHooks = 0;
            let totalFreeBombs = 0;
            
            for (let day = 1; day <= 7; day++) {
                const hooks = parseInt(document.getElementById(`free-day-${day}-hooks`).value) || 0;
                const bombs = parseInt(document.getElementById(`free-day-${day}-bombs`).value) || 0;
                
                totalFreeHooks += hooks;
                totalFreeBombs += bombs;
            }
            
            const totalFreeExp = (totalFreeHooks * 15) + (totalFreeBombs * 10); // 假設鉤子15經驗，炸彈10經驗
            
            // 更新免費領取總計顯示
            document.getElementById('free-hooks').textContent = totalFreeHooks.toLocaleString();
            document.getElementById('free-bombs').textContent = totalFreeBombs.toLocaleString();
            document.getElementById('free-exp').textContent = totalFreeExp.toLocaleString();
            
            return { hooks: totalFreeHooks, bombs: totalFreeBombs, exp: totalFreeExp };
        }

        // 更新每日消費計算
        function updateDailyCalculations() {
            let totalDailyHooks = 0;
            let totalDailyBombs = 0;
            let totalDailyLeaves = 0;
            
            for (let day = 1; day <= 7; day++) {
                const bombs = parseInt(document.getElementById(`day-${day}-bombs`).value) || 0;
                const leaves = parseInt(document.getElementById(`day-${day}-leaves`).value) || 0;
                
                // 計算當天可獲得的鉤子 (消費獎勵)
                const hooksFromLeaves = calculateHooksFromLeaves(leaves);
                
                // 更新當天鉤子顯示
                document.getElementById(`day-${day}-hooks`).textContent = hooksFromLeaves;
                
                // 累加總計
                totalDailyHooks += hooksFromLeaves;
                totalDailyBombs += bombs;
                totalDailyLeaves += leaves;
            }
            
            // 更新每日總計顯示
            document.getElementById('daily-hooks').textContent = totalDailyHooks.toLocaleString();
            document.getElementById('daily-bombs').textContent = totalDailyBombs.toLocaleString();
            document.getElementById('daily-leaves').textContent = totalDailyLeaves.toLocaleString();
            
            return { hooks: totalDailyHooks, bombs: totalDailyBombs, leaves: totalDailyLeaves };
        }

        // 更新儲值計算
        function updateTopupCalculation() {
            const totalTopup = parseInt(document.getElementById('total-topup').value) || 0;
            let totalHooks = 0;
            
            // 計算可獲得的鉤子獎勵
            for (const reward of topupRewards) {
                if (totalTopup >= reward.leaves) {
                    totalHooks += reward.hooks;
                }
            }
            
            // 更新顯示
            document.getElementById('topup-hooks').textContent = totalHooks.toLocaleString();
            
            return totalHooks;
        }

        // 更新禮包計算
        function updatePackageCalculation() {
            let totalHooks = 0;
            let totalCost = 0;
            
            packages.forEach((pkg, index) => {
                const checkbox = document.getElementById(`package-${index}`);
                const quantityInput = document.getElementById(`package-${index}-qty`);
                
                if (checkbox.checked) {
                    const quantity = parseInt(quantityInput.value) || 0;
                    const validQuantity = Math.min(quantity, pkg.limit);
                    totalHooks += validQuantity * pkg.hooks;
                    totalCost += validQuantity * pkg.price;
                }
            });
            
            // 更新顯示
            document.getElementById('package-hooks').textContent = totalHooks.toLocaleString();
            document.getElementById('package-cost').textContent = `${totalCost.toLocaleString()} NTD`;
            
            return totalHooks;
        }

        // 更新等級進度條
        function updateLevelProgress(currentExp) {
            const progressFill = document.getElementById('level-progress');
            
            // 找到當前等級和下一等級
            let currentLevel = 1;
            let currentLevelExp = 0;
            let nextLevelExp = levelData[0].totalExp;
            
            for (let i = 0; i < levelData.length; i++) {
                if (currentExp >= levelData[i].totalExp) {
                    currentLevel = levelData[i].level;
                    currentLevelExp = levelData[i].totalExp;
                    nextLevelExp = i < levelData.length - 1 ? levelData[i + 1].totalExp : levelData[i].totalExp;
                } else {
                    break;
                }
            }
            
            // 計算進度百分比
            if (currentLevel >= 40) {
                progressFill.style.width = '100%';
            } else {
                const progress = ((currentExp - currentLevelExp) / (nextLevelExp - currentLevelExp)) * 100;
                progressFill.style.width = `${Math.min(progress, 100)}%`;
            }
        }

        // 更新總計計算
        function updateTotalCalculation() {
            try {
                const currentExp = parseInt(document.getElementById('current-exp').value) || 0;
                const currentHooks = parseInt(document.getElementById('current-hooks').value) || 0;
                const currentBombs = parseInt(document.getElementById('current-bombs').value) || 0;
                const hookExpRatio = parseInt(document.getElementById('hook-exp-value').value) || 15;
                
                const free = updateFreeCalculations();
                const daily = updateDailyCalculations();
                const topupHooks = updateTopupCalculation();
                const packageHooks = updatePackageCalculation();
                
                // 計算總資源
                const estimatedHooks = free.hooks + daily.hooks + topupHooks + packageHooks;
                const estimatedBombs = free.bombs + daily.bombs;
                const totalLeaves = daily.leaves;
                
                // 計算總經驗（包含目前鉤子和炸彈）
                const expFromCurrentHooks = currentHooks * hookExpRatio;
                const expFromCurrentBombs = currentBombs * 10;
                const expFromEstimatedHooks = estimatedHooks * hookExpRatio;
                const expFromEstimatedBombs = estimatedBombs * 10;
                const totalExp = currentExp + expFromCurrentHooks + expFromCurrentBombs + expFromEstimatedHooks + expFromEstimatedBombs;
                
                // 計算預估等級和獎勵
                let estimatedLevel = 1;
                let estimatedReward = "";
                for (let i = levelData.length - 1; i >= 0; i--) {
                    if (totalExp >= levelData[i].totalExp) {
                        estimatedLevel = levelData[i].level;
                        estimatedReward = levelData[i].reward;
                        break;
                    }
                }
                
                // 更新顯示
                document.getElementById('hook-result').textContent = `${estimatedHooks.toLocaleString()}｜${expFromEstimatedHooks.toLocaleString()}`;
                document.getElementById('bomb-result').textContent = `${estimatedBombs.toLocaleString()}｜${expFromEstimatedBombs.toLocaleString()}`;
                document.getElementById('total-leaves').textContent = totalLeaves.toLocaleString();
                document.getElementById('total-exp').textContent = totalExp.toLocaleString();
                document.getElementById('estimated-level').textContent = `LV${estimatedLevel} - ${estimatedReward}`;
                
                // 更新進度條
                updateLevelProgress(totalExp);
                
                return { 
                    hooks: estimatedHooks, 
                    bombs: estimatedBombs, 
                    leaves: totalLeaves, 
                    totalExp, 
                    level: estimatedLevel,
                    reward: estimatedReward
                };
            } catch (error) {
                console.error('計算錯誤:', error);
                // 顯示錯誤訊息給用戶
                document.getElementById('estimated-level').textContent = '計算錯誤，請檢查輸入值';
            }
        }

        // 高亮當前等級 - 改進版本（高亮所有已達到的等級）
        function highlightCurrentLevel() {
            const totalExpText = document.getElementById('total-exp').textContent;
            const totalExp = parseInt(totalExpText.replace(/,/g, '')) || 0;
            const rows = document.querySelectorAll('#reward-table tbody tr');
            
            // 先移除所有高亮
            rows.forEach(row => {
                row.classList.remove('achieved-level');
            });
            
            // 高亮所有已達到的等級
            for (let i = 0; i < levelData.length; i++) {
                if (totalExp >= levelData[i].totalExp) {
                    rows[i].classList.add('achieved-level');
                } else {
                    break; // 一旦找到第一個未達到的等級就停止
                }
            }
        }

        // 更新所有計算
        function updateAllCalculations() {
            updateTotalCalculation();
            highlightCurrentLevel();
        }

        // 頁面載入時初始化
        window.addEventListener('DOMContentLoaded', init);

        // 添加鍵盤快捷鍵支援
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                
                // 重置所有輸入
                document.querySelectorAll('input[type="number"]').forEach(input => {
                    if (input.id === 'hook-exp-value') {
                        input.value = '15';
                    } else {
                        input.value = '0';
                    }
                });
                
                // 重置每日免費領取下拉選單
                for (let day = 1; day <= 7; day++) {
                    const defaultHooks = (day === 1 || day === 2) ? "0" : "20";
                    const defaultBombs = (day === 1 || day === 2) ? "0" : "2";
                    document.getElementById(`free-day-${day}-hooks`).value = defaultHooks;
                    document.getElementById(`free-day-${day}-bombs`).value = defaultBombs;
                }
                
                document.getElementById('total-topup').value = '0';
                document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
                updateAllCalculations();
            }
        });
    </script>
</body>
</html>
        
